<!DOCTYPE html>
<html>
<head>
  <title></title>
</head>
<body style="background-color: #333333;">
  <script src="tween.js"></script>
  <script src="shapes.js"></script>
  <script src="../avm2/options.js"></script>
  <script>
    var Option = options.Option;
    var OptionSet = options.OptionSet;
    var coreOptions = new OptionSet("Core Options");
  </script>
  <script src="../avm2/avm2Util.js"></script>
  <script src="../swf/util.js"></script>
  <script src="../flash/util.js"></script>
  <script src="../../examples/inspector/js/classes/Timeline.js"></script>
  <script src="../../examples/inspector/js/classes/dat.gui.min.js"></script>
  <script src="util.js"></script>
  <script src="geometry.js"></script>
  <script src="stage.js"></script>
  <script src="elements.js"></script>
  <script src="gl.js"></script>
  <script>
    var Point = Shumway.Geometry.Point;
    var Rectangle = Shumway.Geometry.Rectangle;
    var Matrix = Shumway.Geometry.Matrix;
    var Stage = Shumway.Layers.Stage;
    var Snow = Shumway.Layers.Elements.Snow;
    var Bitmap = Shumway.Layers.Elements.Bitmap;
    var Video = Shumway.Layers.Elements.Video;
    var Text = Shumway.Layers.Elements.Text;
    var Shape = Shumway.Layers.Elements.Shape;
    var Slider = Shumway.Layers.Elements.Slider;
    var WebGLContext = Shumway.GL.WebGLContext;
    var WebGLStageRenderer = Shumway.GL.WebGLStageRenderer;
  </script>
  <style>
    #debugInfoContainer {
      position: absolute;
      top: 500px;
      bottom: 0px;
      right: 0;
      width: 300px;
      overflow-y: auto;
      overflow-x: hidden;
      background-color: rgba(0, 0, 0, 0.2);

      -webkit-box-sizing: border-box;
      -moz-box-sizing: border-box;
      box-sizing: border-box;
    }
  </style>


  <div>
    <div style="float: left; width: 512px;">
      <canvas id="frameTimeline" height="100" style="background-]color: #333333;"></canvas>
    </div>
    <div style="margin-left: 10px; float: left; width: 512px;">

    </div>
  </div>

  <div style="clear: both;">
    <!--<video id="video" src="http://upload.wikimedia.org/wikipedia/commons/4/41/Big_Buck_Bunny_medium.ogv" controls="true"></video>-->
    <!--<video id="video" src="http://upload.wikimedia.org/wikipedia/commons/7/79/Big_Buck_Bunny_small.ogv" controls="true"></video>-->
    <!--<canvas id="stageCanvas" width="512" height="256" style="background-color: #1F1F21;"></canvas>-->
    <canvas id="stageCanvas" width="2048" height="1024" style="background-color: #1F1F21;"></canvas>
    <!--<canvas id="stageCanvas" style="background-color: #1F1F21;"></canvas>-->
  </div>
  <script>

    function shuffle(target, easing) {
      var tween = new TWEEN.Tween(target);
      tween.easing(easing);
      function next() {
        var w = 128, h = 128;
        var x = Math.max(0, Math.random() * (canvas.width - w));
        var y = Math.max(0, Math.random() * (canvas.height - h));
        var s = 0.25 + Math.random() * 2;
        // var s = (Math.random() - 0.5) * 10;
        tween.easing(easing);
        tween.delay(Math.random() * (500000 / sceneOptions.movement));
        tween.to({
          x: x,
          y: y,
          scaleX: s,
          scaleY: s
          // rotation: (Math.random() - 0.5) * 180
        }, 100000 / sceneOptions.speed).start();
//        if (Math.random() < 0.1) {
//          tween.stop();
//        }
      }
      next();
      tween.onComplete(next);
      tween.start();
    }

    // var seed = 20;
    // Math.random = function () {
    //    var x = Math.sin(seed++) * 10000;
    //    return x - Math.floor(x);
    // };


    var timeline;

    if (true) {
      timeline = new Timeline(document.getElementById("frameTimeline"));
      timeline.setFrameRate(60);
      timeline.refreshEvery(60);
    }

    function timelineEnter(name) {
      timeline && timeline.enter(name);
    }

    function timelineLeave(name) {
      timeline && timeline.leave(name);
    }

    var canvas = document.getElementById("stageCanvas");

    var pixelRatio = 'devicePixelRatio' in window ? window.devicePixelRatio : 1;

    var width = window.innerWidth * 0.75 | 0;
    var height = width / 2 | 0;

    canvas.style.width = width + 'px';
    canvas.style.height = height + 'px';
    canvas.width = width * pixelRatio;
    canvas.height = height * pixelRatio;


    var gui = new dat.GUI();

    var sceneOptions = {
      flakes: 1,
      shapes: 0,
      bitmaps: 2,
      videos: 2,
      text: 1,
      cacheAsBitmap: false,
      webGL: false,

      movement: 20,
      speed: 20,
      render: true,
      animate: true,
      drawElements: true,
      drawDirtyRegions: false,
      drawLayers: false,
      clear: true,
      imageSmoothing: true,
      snap: false,
      alpha: false,
      frameRate: 5,

      stop: function () {
        frames = Number.MAX_VALUE;
      }
    };

    gui.remember(sceneOptions);

    (function addSceneOptions() {
      var f = gui.addFolder("Scene Options");
      var c = [];
      c.push(f.add(sceneOptions, "flakes", 0, 50000).step(1));
      c.push(f.add(sceneOptions, "shapes", 0, 100).step(1));
      c.push(f.add(sceneOptions, "bitmaps", 0, 10000).step(2));
      c.push(f.add(sceneOptions, "videos", 0, 1000).step(1));
      c.push(f.add(sceneOptions, "text", 0, 1000).step(1));
      c.push(f.add(sceneOptions, "cacheAsBitmap"));
      c.push(f.add(sceneOptions, "webGL"));
      f.open();
      c.forEach(function (x) {
        x.onFinishChange(updateScene);
      })
    })();

    (function addOptions() {
      var f = gui.addFolder("Options");
      var c = [];
      c.push(f.add(sceneOptions, "movement", 1, 1000).step(1));
      c.push(f.add(sceneOptions, "speed", 0.1, 200).step(0.1));
      c.push(f.add(sceneOptions, "frameRate", 1, 60).step(1));
      c.push(f.add(sceneOptions, "render"));
      c.push(f.add(sceneOptions, "drawElements"));
      c.push(f.add(sceneOptions, "animate"));
      c.push(f.add(sceneOptions, "drawDirtyRegions"));
      c.push(f.add(sceneOptions, "drawLayers"));
      c.push(f.add(sceneOptions, "clear"));
      c.push(f.add(sceneOptions, "imageSmoothing"));
      c.push(f.add(sceneOptions, "snap"));
      c.push(f.add(sceneOptions, "alpha"));
      f.open();
      c.forEach(function (x) {
        x.onFinishChange(updateOptions);
      })
    })();



    (function addButtons() {
      var f = gui.addFolder("Commands");
      var c = [];
      c.push(f.add(sceneOptions, "stop"));
      f.open();
    })();

    var context, renderer;
    if (sceneOptions.webGL) {
      context = new WebGLContext(canvas);
      renderer = new WebGLStageRenderer(context);
    } else {
      context = canvas.getContext("2d");
    }
    context.font = 12 + 'px Consolas, "Liberation Mono", Courier, monospace';

    var stage, animators;

    var videoElements = [];

    function ensureLoadedVideos() {
      if (videoElements.length > 0) {
        return;
      }
      var urls = [
        // "assets/oceans.webm",
        "assets/elephants-dream.webm"
        // "http://upload.wikimedia.org/wikipedia/commons/7/79/Big_Buck_Bunny_small.ogv",
        // "http://video.webmfiles.org/elephants-dream.webm",
        // "http://video.webmfiles.org/big-buck-bunny_trailer.webm"
      ];

      urls.forEach(function (url) {
        var videoElement = document.createElement("video");
        videoElement.src = url;
        videoElement.loop = true;
        videoElement.muted = true;
        videoElements.push(videoElement);
        videoElement.play();

//        videoElement.addEventListener('timeupdate', function() {
//          var location = videoElement.textureAtlasLocation;
//          if (location) {
//            location.atlas.update(videoElement, location.region);
//          }
//        }, false);

      });
    }

    function updateScene() {
      stage = new Stage(canvas.width, canvas.height);
      animators = [];

      var snow = new Snow(sceneOptions.flakes, 32, canvas.width, canvas.height);
      animators.push(snow);
      stage.addChild(snow);

      for (var i = 0; i < sceneOptions.text; i++) {
        var frame = new Shape(renderTextShape(randomText()), 256, 200, sceneOptions.cacheAsBitmap);
        frame.x = (Math.random()) * canvas.width;
        frame.y = (Math.random()) * canvas.height;
        frame.alpha = Math.random();
        stage.addChild(frame);
        shuffle(frame, TWEEN.Easing.Exponential.Out);
      }

      for (var i = 0; i < sceneOptions.shapes; i++) {
        var frame = new Shape(renderGuy, 100, 110, sceneOptions.cacheAsBitmap);
        frame.x = (Math.random()) * canvas.width;
        frame.y = (Math.random()) * canvas.height;
        frame.alpha = Math.random();
        stage.addChild(frame);
        shuffle(frame, TWEEN.Easing.Exponential.Out);
      }

      var image = document.createElement("img");
      image.src = "assets/firefox_logo_small.png";

      for (var i = 0; i < sceneOptions.bitmaps; i++) {
        var frame = new Bitmap(image);
        frame.x = (Math.random()) * canvas.width;
        frame.y = (Math.random()) * canvas.height;
        frame.alpha = Math.random();
        stage.addChild(frame);
        shuffle(frame, TWEEN.Easing.Exponential.Out);
      }

      for (var i = 0; i < sceneOptions.videos; i++) {
        ensureLoadedVideos();
        var videoElement = videoElements[Math.random() * videoElements.length | 0];
        var frame = new Video(videoElement);
        frame.x = Math.random() * 1000;
        frame.y = Math.random() * 100;
        frame.alpha = Math.random();
        stage.addChild(frame);
        shuffle(frame, TWEEN.Easing.Exponential.Out);
      }

      stage.shuffleChildren();
    }

    function updateOptions() {
      context.imageSmoothingEnabled = context.mozImageSmoothingEnabled = sceneOptions.imageSmoothing;
    }

    updateScene();

    var mousePosition;

    window.requestAnimationFrame = (function(){
      return function(callback) {
        window.setTimeout(callback, 1000 / sceneOptions.frameRate);
      };
    })();

    var frames = 0;

    (function tick() {

      for (var i = 0; i < videoElements.length; i++) {
        var videoElement = videoElements[i];
        var location = videoElement.textureAtlasLocation;
        if (location) {
          if (videoElement.lastCurrentTime !== videoElement.currentTime) {
            location.atlas.update(videoElement, location.region);
          }
          videoElement.lastCurrentTime = videoElement.currentTime;
        }
      }

      timelineEnter("FRAME");
      var now = performance.now();
      if (sceneOptions.animate) {
        TWEEN.update();
        timelineEnter("ANIMATE");
        animators.forEach(function (animator) {
          animator.onEnterFrame(now);
        });
        timelineLeave("ANIMATE");
      }
      if (sceneOptions.render) {
        timelineEnter("RENDER");
        if (sceneOptions.webGL) {

          /*
          stage.render(context, {
            drawLayers: sceneOptions.drawLayers,
            snap: sceneOptions.snap,
            alpha: sceneOptions.alpha
          });
          context.flush();
          */

          renderer.render(stage, sceneOptions.drawElements);
        } else {
          if (sceneOptions.clear) {
            context.fillStyle = "#1F1F21";
            if (!sceneOptions.webGL) {
              context.fillRect(0, 0, stage.w, stage.h);
            }
          }
          stage.render(context, {
            drawLayers: sceneOptions.drawLayers,
            snap: sceneOptions.snap,
            alpha: sceneOptions.alpha
          });
          if (sceneOptions.drawDirtyRegions) {
            stage.dirtyRegion.render(context, {
              drawGrid: false
            });
          }
        }

        timelineLeave("RENDER");
      }

      timelineLeave("FRAME");
      stage.dirtyRegion.clear();
      if (frames ++ < 10000) {
        requestAnimationFrame(tick);
      }
    })();

    function getMousePosition(canvas, evt) {
      var rect = canvas.getBoundingClientRect();
      return {
        x: evt.clientX - rect.left,
        y: evt.clientY - rect.top
      };
    }

    var originalPosition;

    canvas.addEventListener('mousemove', function(evt) {
      mousePosition = getMousePosition(canvas, evt);
    }, false);

  </script>
</body>
</html>